# 系统结构期末复习

https://wenku.baidu.com/view/f6f84ab0f71fb7360b4c2e3f5727a5e9856a27d5.html?re=view

## 第一章

### 提高处理机处理能力的三个方法

- 提高CPU的时钟频率，即减小CPU执行时间？
  - 一个处理机在刚推出时适用的主频没有这样大的富余度，不太现实

- 将CPU的流水线条数增加为n条，在理想情况下其运行速度可以提高n倍？
  - 速度相差太大，需要增加的流水线数目也相当大
  - 工艺实现困难
  - 流水线条数过多，指令的分配和调度也会有许多困难。
- 设计专门的多媒体指令及处理硬件，大幅度提高同一条指令处理大量数据的能力
  - 程序在CPU上运算时间由公共工作（处理同一批数据指令）

### 局部性原理

> 程序执行所访问的存储器地址分布不是随机的，而是相对地簇聚

- 时间局部性
  - 程序即将用到的信息很可能就是目前正在使用的信息
- 空间局部性
  - 程序即将用到的信息很可能与目前正在使用的信息在空间上相邻或接近

### 冯诺依曼结构的特点

- 以运算器为中心
- 在存储器中，指令和数据同等对待
- 存储器是按地址访问、按顺序线性编址的一维结构，每个单元的位数是固定的
- 指令的执行是顺序的
- 指令由操作码和地址码组成
- 指令和数据均以二进制编码表示，采用二进制运算。

### 并行性的实现途径

#### 时间重叠（流水线技术）

引入时间因素，让多个处理过程在时间上相互错开，轮流重叠地使用同一套硬件设备的各个部分，以加快硬件周转而赢得速度。

#### 资源重复（超标量处理机、阵列处理机）

引入空间因素，以数量取胜。通过重复设置硬件资源，大幅度地提高计算机系统的性能，资源重复是实现并行性中的同时性

#### 资源共享（多道程序、分时系统、计算机网络、分布处理系统）

是一种软件方法，它使得多个任务按一定时间顺序轮流使用同一套硬件设备。

## 第三章

### 流水线种类

#### 按处理机分类

- 操作部件级

- 处理机级
- 处理机间级
  - ![image-20200518155912202](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200518155912202.png)

#### 按流水线功能多少分类

- 单功能流水线
  - 指一条流水线只能完成一种单一的任务
- 多功能流水线
  - 能够在一个是夹断内后不同时间段改变部件之间的链接，从而达到改变其功能的流水线。

#### 按照工作方式分类

- 静态流水线
  - 当执行某一规定功能的指令全部流出后，才允许改变部件间连接的流水线

- 动态流水线
  - 没有这种时间上的闲置，可以在任何时候根据需要改变其连接

#### 按照连接方式分类

- 线性流水线
  - 部件上没有反馈连接的流水线。在这种流水线中，指令一次通过各个部件仅一次，完成指令执行的全过程

- 非线性流水线
  - 各部件除了串行的连接外，某些部件可能通过反馈线而重复使用

#### 按流入流出顺序分类

- 顺序流水线
  - 输出结果与输入次序相同，早期的流水线又称顺序流水线
- 乱序流水线

### 整个流水线效率很低的原因

- 存在有**数据相关**，发生数据相关时，必须等待前一个运算结果产生之后，下一个运算才能开始
- 流水线中有填入和排空部分，当输入到流水线中的任务不多时，填入与排空部分所占的比例较大。

### 流水线设计的若干问题

#### 瓶颈问题

- 当流水线各段不均匀时，机器的始终周期取决于瓶颈段的延迟时间。
- 在设计流水线时，要尽可能使各段时间相等。

#### 流水线的额外开销

- 流水寄存器延迟
- 时钟偏移开销

#### 冲突问题

- 最经典，最重要的问题之一。

### 流水线的相关

> 相关是指两条指令之间存在某种**依赖**关系
>
> 如果流水线始终处于充满的状态，实际性能便可能接近理论值

造成断流原因主要分为三大类

- 名相关
- 数据相关
- 控制相关

#### 名相关

名：指令所访问的寄存器或存储单元的名称（既可以理解为，不通指令都要去掺和这个临界资源）

如果两条指令使用相同的名，且他们之间不存在数据流动，则称这两条指令存在名相关。

- 反相关（先读后写，两者紧挨着。由于流水线共用部件，在某个子操作的位置很可能发生冲突）
- 输出相关（两条指令同时写相同的名）

解决方法：通过改变指令中操作数的名称来消除名相关。

#### 数据相关

> ![image-20200518200901716](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200518200901716.png)

- 数据相关具有**传递性**

- 数据相关反应了数据的流动关系，即如何从其生产者流动到其消费者

当数据流动是经过寄存器时，相关的检测比较直观和容易。

当数据流动是经过存储器的时候，检测通常比较复杂

- 形式相同的地址其物理地址未必相同
- 形式不同的地址其有效地址可能相同

#### 控制相关

控制能管管是由分支指令引起的相关（经典的结构有if-then）

两个限制：

- 与一条分支指令控制相关的指令不能被移动到该分支之前，否则这些指令就不受该分支控制了。
- 如果一条指令与某分支不存在控制相关，则不应把该指令移动到该分支之后。

### 流水线冲突（HARZARD）问题

> 流水线冲突是指对于具体的流水线来说，由于相关的存在，使得指令流的下一条指令不能在指定的时钟周期执行。

流水线冲突有三类

- 结构冲突（资源冲突）
- 数据冲突
- 控制冲突

#### 结构冲突（资源冲突）

多条指令进入流水线后，在同一时间征用同一功能部件，从而发生冲突。

![image-20200519075458924](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519075458924.png)

解决办法：暂停一拍（流水线气泡）

![image-20200519075536444](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519075536444.png)

#### 数据冲突

由于流水线中各指令重叠执行，使得原来对操作数的访问顺序发生变化。从而引起的一种数据冲突

![image-20200519075640387](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519075640387.png)

解决办法：定向传送技术（直接把需要用到的数据在ALU等部件得到之后直接传送到下一指令实际需要的位置，而不必等待整条指令流过流水线）

**数据冲突类型**：

- **RAW读超前于写**

![image-20200519094244474](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519094244474.png)

但是装入延迟的时候就无法解决这个问题。

![image-20200519094358827](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519094358827.png)

![image-20200519094433733](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519094433733.png)

但是由于可以非按输入循序执行指令，可能引起其他的冲突

- **WAR写超前于读**

原程序要求对**同一单元**进行先读后写的操作，可能因为非按序执行成为先写后读，曹成出错

- **写后写**

原程序中如果两条指令都要对同一单元进行写数操作，可能因为非按序执行的原因，改变了两条指令写入的次序。

#### 控制冲突

流水线遇到分支指令和其他会改变PC值的指令所引起的冲突

![image-20200519095643484](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519095643484.png)

解决措施：

- 在流水线中尽早判断出分支转移是否成功
- 尽早计算出分支目标地址

##### 通过软件（编译器）减少延迟的方式

- 预测分支失败
  - ![image-20200519095821831](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519095821831.png)
  - ![image-20200519095906089](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519095906089.png)
  - 
- 预测分支成功
  - ![image-20200519100007536](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519100007536.png)

- 采用延迟转移技术

### 流水线的实现（以MIPS指令为例）

#### 五个时钟周期

1. 取指令周期IF

   ![image-20200519102730739](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519102730739.png)

2. 指令译码/读寄存器周期ID

   ![image-20200519102809500](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519102809500.png)

3. 执行/有效地址计算周期EX

4. 存储器访问/分支完成指令 MEM
	所有指令都要在该周期对PC进行更新，除了分支指令，其他指令都是做PC<-NPC
    且注意到，在该周期内处理的MIPS仅仅只有load store和分支指令
   
   ![image-20200519103401198](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519103401198.png)
   
5. 写回周期（WB）

   ![image-20200519103539675](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519103539675.png)

### 指令的调度

#### 静态调度

- 依靠编译器对代码进行静态调整，以减少相关和冲突
- 它不是在程序执行的过程中，而是在编译期间进行代码调度和优化
- 通过把相关的指令拉开距离来减少可能产生的停顿

#### 动态调度

- 在程序执行过程中，依靠专门硬件对代码进行调度，减少数据相关导致的停顿

之前的基本流水线中，在ID即第二步，取指令译码阶段是同时检测结构冲突和检测数据冲突的。

一旦一条指令受阻，其后的指令都将停顿。一个针对传统基本流水线遇到这个的问题的解决方法即**允许乱序执行**

![image-20200519143207902](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519143207902.png)

#### Tomasulo算法（指令的动态调度中，通过寄存器重命名来消除可能的WAR和WAW冲突）

核心思想：

- 记录和检测指令**相关**，操作数一旦就绪就立即执行，把发生RAW冲突的可能性减少到最小。
- 通过寄存器换名来消除WAR冲突和WAW冲突。

两个特点：

- 冲突检测和指令执行控制是分布的
  - 每个功能部件的保留站中的信息决定了什么时候可以在该功能部件开始执行
- 计算结果通过CDB直接从它的保留站传送到所有需要它的功能部件，而不讲过寄存器。

#### 动态分支预测

> 程序运行时，根据分支指令过去的表现来预测其将来的行为
>
> - 如果分支行为发生了变化，预测行为也跟着改变
> - 有更好的预测准确度和适应性
>
> 需要解决的问题
>
> - 如何记录分支的历史信息
> - 如何根据这些信息来预测分支的走向

##### 采用分支历史表 BHT（branch history Table）

 也称为分支预测缓冲器，是最简单的动态分支预测方法。用BHT来记录分支指令最近一次或几次的执行情况（是否成功），并据此进行预测。

1. 只有一个预测位的分支预测缓冲
   1. 记录分支指令最近一次的历史，BHT中只需要1位二进制位。

2. 采用两位二进制位来记录历史

   1. 可以提高预测的准确度
   2. 且研究表明两位分支预测的性能与n位分支预测的性能差不多

   ![image-20200519151859524](%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0.assets/image-20200519151859524.png)

   

#### 多指令流出技术

##### 超标量处理机（空间并行）

- 把一个时钟周期内能够同时发射多条指令的处理机称为超标量处理机

- 超标量处理机最基本的要求是要有两套或两套以上完整的指令执行部件
- 为了能够在一个时钟周期内同时发射多条指令，超标量处理机必须有两条或两条以上能够同时工作的指令流水线。

##### 超长指令字VLIW （Very Long Instruction Word）

- 依靠编译器把能并行执行的多条指令组装成一条很长的指令，并设置多个功能部件。指令字被分割成一些字段，每个字段称为一个操作槽，直接独立地控制一个功能部件。

##### 多流出流水线的调度问题

1. 顺序发射顺序完成（可采用定向技术）
2. 顺序发射乱序完成（可采用定向技术）
3. 乱序发射乱序完成（可采用定向技术）
   1. 采用了先行窗口
      - 能够从指令中预取多条指令
      - 能够对窗口内的指令进行数据相关性能分析和功能部件冲突的检测

##### 超流水线处理机

> 在一个时钟周期内能够分时发射多条指令的处理机称为超流水线处理机。

